<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Report di Messa in Fase Macchinario</title>
<style>
body {
font-family: Arial, sans-serif;
margin: 15px;
color: #333;
line-height: 1.6;
background-color: #f4f7f6;
}
.container {
max-width: 800px;
margin: auto;
border: 1px solid #e0e0e0;
padding: 20px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
background-color: #fff;
border-radius: 8px;
}
h1, h2 {
color: #1a5276;
border-bottom: 2px solid #aebfd0;
padding-bottom: 8px;
margin-top: 25px;
}
h1 {
text-align: center;
font-size: 1.8em;
}
h2 {
font-size: 1.4em;
}
.section {
margin-bottom: 25px;
}
.form-group {
margin-bottom: 15px;
}
.form-group label {
display: block;
margin-bottom: 5px;
font-weight: bold;
font-size: 0.95em;
}
.form-group input[type="text"], .form-group textarea, .form-group select, .form-group input[type="number"], .form-group input[type="date"] {
width: 100%;
padding: 10px;
box-sizing: border-box;
border: 1px solid #ccc;
border-radius: 5px;
font-size: 0.9em;
}
.form-group input[type="checkbox"] {
margin-right: 8px;
}
.checklist-item {
background-color: #f9f9f9;
border: 1px solid #eee;
border-radius: 6px;
padding: 12px;
margin-bottom: 15px;
display: flex;
flex-direction: column;
gap: 8px;
}
.checklist-item .item-header {
display: flex;
align-items: center;
font-weight: bold;
}
.checklist-item .item-header input[type="checkbox"] {
margin-right: 10px;
min-width: 18px;
min-height: 18px;
}
.checklist-item .item-notes, .checklist-item .item-measurement {
width: 100%;
padding: 8px;
box-sizing: border-box;
border: 1px solid #ddd;
border-radius: 4px;
font-size: 0.85em;
}
.measurement-group {
border: 1px solid #e0e0e0;
border-radius: 4px;
padding: 8px;
margin-top: 5px;
background-color: #f0f0f0;
display: flex;
flex-direction: column;
gap: 5px;
}
.measurement-group input[type="text"] {
width: 100%;
padding: 6px;
box-sizing: border-box;
border: 1px solid #ccc;
border-radius: 3px;
}
.image-container {
margin-top: 10px;
display: flex;
flex-wrap: wrap;
gap: 10px;
}
.image-preview {
max-width: 100px;
height: auto;
border-radius: 6px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
cursor: pointer;
}
.upload-btn {
background-color: #1a5276;
color: white;
padding: 8px 12px;
border-radius: 4px;
cursor: pointer;
text-align: center;
font-size: 0.9em;
display: block;
margin-top: 5px;
}
.progress-container {
width: 100%;
background-color: #e0e0e0;
border-radius: 5px;
margin-top: 20px;
margin-bottom: 25px;
overflow: hidden;
}
.progress-bar {
width: 0%;
height: 25px;
background-color: #4CAF50;
text-align: center;
line-height: 25px;
color: white;
border-radius: 5px;
transition: width 0.3s ease-in-out;
font-weight: bold;
}
.signature-area {
display: flex;
flex-direction: column;
gap: 20px;
margin-top: 40px;
}
.signature-box {
border-bottom: 1px solid #000;
padding-bottom: 5px;
width: 100%;
}
.hidden-input {
display: none;
}
/* Gestione macchinari e configurazione */
#machineManagement {
background-color: #e6f0f5;
padding: 15px;
border-radius: 8px;
margin-bottom: 25px;
}
#machineManagement select, #machineNameInput {
width: 100%;
margin-bottom: 10px;
}
.btn {
padding: 8px 12px;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 0.9em;
}
.add-btn {
background-color: #28a745;
color: white;
width: 100%;
margin-top: 10px;
padding: 12px 20px;
font-size: 1.1em;
font-weight: bold;
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
}
.pdf-btn {
background-color: #007bff;
color: white;
padding: 12px 20px;
font-size: 1em;
width: 100%;
box-sizing: border-box;
border: none;
border-radius: 5px;
cursor: pointer;
margin-bottom: 10px;
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
}
.delete-btn {
background-color: #dc3545;
color: white;
}
.manage-btn, .save-btn, .new-machine-btn, #loadReportBtn {
background-color: #007bff;
color: white;
padding: 12px 20px;
font-size: 1em;
width: 100%;
box-sizing: border-box;
border: none;
border-radius: 5px;
cursor: pointer;
margin-bottom: 10px;
}
/* Modal per visualizzazione foto */
#photoModal, #confirmModal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.9);
justify-content: center;
align-items: center;
}
#photoModal {
background-color: rgba(0,0,0,0.9);
}
#modalImage {
margin: auto;
display: block;
max-width: 90%;
max-height: 90%;
}
.modal-close {
position: absolute;
top: 15px;
right: 35px;
color: #f1f1f1;
font-size: 40px;
font-weight: bold;
transition: 0.3s;
cursor: pointer;
}
/* Stili per la configurazione a una colonna */
#configSection {
display: none;
background-color: #e6f0f5;
padding: 15px;
border-radius: 8px;
margin-bottom: 25px;
}
.config-item {
background-color: #fff;
padding: 10px;
border: 1px solid #ccc;
border-radius: 5px;
margin-bottom: 10px;
display: flex;
flex-direction: column;
gap: 8px;
position: relative;
}
.config-item-header {
display: flex;
justify-content: space-between;
align-items: center;
cursor: pointer;
font-weight: bold;
}
.config-item-content {
display: none;
flex-direction: column;
gap: 10px;
padding-top: 10px;
border-top: 1px solid #eee;
}
.config-item.active .config-item-content {
display: flex;
}
.config-item .btn-group {
display: flex;
gap: 5px;
justify-content: flex-end;
margin-top: 5px;
}
.sortable-list .config-item:hover {
box-shadow: 0 0 5px rgba(0,0,0,0.2);
}
.handle {
cursor: grab;
margin-right: 10px;
font-size: 1.5em;
line-height: 1;
}
/* Modale di conferma */
#confirmModal .modal-content {
background-color: #fff;
padding: 20px;
border-radius: 8px;
text-align: center;
box-shadow: 0 4px 8px rgba(0,0,0,0.2);
max-width: 400px;
width: 90%;
position: relative;
}
#confirmModal h3 {
margin-top: 0;
color: #dc3545;
}
#confirmModal p {
margin-bottom: 20px;
}
#confirmModal .button-group {
display: flex;
justify-content: space-around;
gap: 10px;
}
#confirmModal .button-group button {
padding: 10px 20px;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 1em;
}
#confirmModal #confirmDeleteBtn {
background-color: #dc3545;
color: white;
}
#confirmModal #cancelDeleteBtn {
background-color: #6c757d;
color: white;
}

/* Message Box */
#messageBox {
display: block;
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
background-color: #4CAF50;
color: white;
padding: 15px 25px;
border-radius: 5px;
box-shadow: 0 4px 8px rgba(0,0,0,0.1);
z-index: 1001;
font-size: 1.1em;
opacity: 0;
transition: opacity 0.5s ease-in-out;
pointer-events: none; /* Rende il box non cliccabile */
}

/* Stili per la stampa */
@media print {
body {
margin: 0;
background-color: #fff;
width: 210mm;
height: 297mm;
}
.container {
box-shadow: none;
border: none;
padding: 10px;
}
input[type="text"], textarea, input[type="number"], input[type="date"] {
border: none;
background: none;
padding: 0;
}
input[type="checkbox"] {
-webkit-appearance: none;
-moz-appearance: none;
appearance: none;
width: 16px;
height: 16px;
border: 1px solid #000;
vertical-align: middle;
}
input[type="checkbox"]:checked:after {
content: '✓';
display: block;
text-align: center;
color: #000;
font-size: 12px;
line-height: 14px;
}
.progress-container, .progress-bar {
background-color: #e0e0e0 !important;
-webkit-print-color-adjust: exact;
color-adjust: exact;
}
.progress-bar {
background-color: #4CAF50 !important;
color: black !important;
}
.upload-btn, .hidden-input, .manage-btn, #configSection, .pdf-btn, .add-btn, .delete-btn, .toggle-btn, #machineManagement, #photoModal, .handle, #messageBox {
display: none !important;
}
.image-preview {
max-width: 150px;
}
}
</style>
</head>
<body>

<div class="container">
<h1>Report di Messa in Fase Macchinario</h1>
<div id="machineManagement">
<h2>Gestione Report</h2>
<p>Seleziona o crea un nuovo report per un macchinario.</p>
<div class="form-group">
<label for="machineSelector">Seleziona Macchinario:</label>
<select id="machineSelector"></select>
<button id="loadReportBtn">Carica Report Selezionato</button>
</div>
<div class="form-group">
<label for="machineNameInput">Nome Nuovo Macchinario:</label>
<input type="text" id="machineNameInput" placeholder="Inserisci un nome">
</div>
<button id="newMachineBtn" class="new-machine-btn">Crea Nuovo Report</button>
<button id="saveReportBtn" class="save-btn" style="display:none;">Salva Report Corrente</button>
</div>

<button id="manageChecklistBtn" class="manage-btn" style="display:none;">Gestisci Step</button>
<button id="generatePdfBtn" class="pdf-btn" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8c-.55 0-1-.45-1-1s.45-1 1-1h8c.55 0 1 .45 1 1s-.45 1-1 1zm0-4H8c-.55 0-1-.45-1-1s.45-1 1-1h8c.55 0 1 .45 1 1s-.45 1-1 1zm-3-5V3.5L18.5 9H13z"/></svg>Genera Report PDF</button>

<div id="configSection" style="display:none;">
<h2>Gestisci Step</h2>
<div id="allStepsList" class="sortable-list"></div>
<button id="addNewStepBtn" class="add-btn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Aggiungi Nuovo Step</button>
<button id="closeConfigBtn" class="pdf-btn">Chiudi Menù</button>
</div>

<div id="mainReportContent" style="display:none;">
<div class="progress-container">
<div class="progress-bar" id="progressBar">0%</div>
</div>
<div class="section">
<h2>Dettagli del Macchinario e dell'Operazione</h2>
<div class="form-group">
<label for="macchinario">Nome Macchinario:</label>
<input type="text" id="macchinario" name="macchinario">
</div>
<div class="form-group">
<label for="modello">Modello:</label>
<input type="text" id="modello" name="modello">
</div>
<div class="form-group">
<label for="seriale">Numero di Serie:</label>
<input type="text" id="seriale" name="seriale">
</div>
</div>
<div class="section">
<h2>Lista di Controllo e Verifica</h2>
<p>Spunta le operazioni completate, inserisci note/misure e allega foto.</p>
<div id="checklistItems"></div>
</div>
<div class="section">
<h2>Riepilogo e Note Finali</h2>
<div class="form-group">
<label for="azioni-correttive">Riepilogo delle azioni correttive:</label>
<textarea id="azioni-correttive" name="azioni-correttive" rows="4"></textarea>
</div>
<div class="form-group">
<label for="note-aggiuntive">Note aggiuntive:</label>
<textarea id="note-aggiuntive" name="note-aggiuntive" rows="4"></textarea>
</div>
</div>
<div class="section">
<h2>Firma</h2>
<div class="signature-area">
<div class="signature-box">Operatore:</div>
<div class="signature-box">Supervisore (se applicabile):</div>
</div>
</div>
</div>
</div>
<div id="photoModal">
<span class="modal-close">&times;</span>
<img id="modalImage">
</div>

<div id="confirmModal">
<div class="modal-content">
<span class="modal-close">&times;</span>
<h3>Conferma Eliminazione</h3>
<p>Sei sicuro di voler eliminare lo step **<span id="stepToDeleteName"></span>**?</p>
<p>Questa azione è irreversibile e lo step verrà rimosso da tutti i report.</p>
<div class="button-group">
<button id="cancelDeleteBtn">Annulla</button>
<button id="confirmDeleteBtn">Elimina</button>
</div>
</div>
</div>

<div id="messageBox">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" style="vertical-align: middle; margin-right: 10px;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
<span>Report salvato!</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const machineSelector = document.getElementById('machineSelector');
const machineNameInput = document.getElementById('machineNameInput');
const newMachineBtn = document.getElementById('newMachineBtn');
const loadReportBtn = document.getElementById('loadReportBtn');
const saveReportBtn = document.getElementById('saveReportBtn');
const manageChecklistBtn = document.getElementById('manageChecklistBtn');
const generatePdfBtn = document.getElementById('generatePdfBtn');
const configSection = document.getElementById('configSection');
const allStepsList = document.getElementById('allStepsList');
const addNewStepBtn = document.getElementById('addNewStepBtn');
const closeConfigBtn = document.getElementById('closeConfigBtn');
const checklistDiv = document.getElementById('checklistItems');
const progressBar = document.getElementById('progressBar');
const photoModal = document.getElementById('photoModal');
const modalImage = document.getElementById('modalImage');
const modalClose = document.querySelector('.modal-close');
const macchinarioField = document.getElementById('macchinario');
const mainReportContent = document.getElementById('mainReportContent');
const messageBox = document.getElementById('messageBox');
// Modale di conferma
const confirmModal = document.getElementById('confirmModal');
const stepToDeleteName = document.getElementById('stepToDeleteName');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
let stepToDeleteId = null;

let allSteps = JSON.parse(localStorage.getItem('allSteps')) || [
{ id: 'step-1', description: "Verifica allineamento cinghie", numMeasurements: 0, stepDescription: "Controllare visivamente l'allineamento delle cinghie di trasmissione e la loro integrità." },
{ id: 'step-2', description: "Controllo tensione catene", numMeasurements: 1, stepDescription: "Utilizzare un tensiometro per verificare che la tensione delle catene rientri nei parametri specificati dal produttore." },
{ id: 'step-3', description: "Verifica e taratura sensori", numMeasurements: 2, stepDescription: "Controllare il corretto funzionamento dei sensori di posizione e, se necessario, calibrarli per garantire la precisione." },
{ id: 'step-4', description: "Regolazione gioco ingranaggi", numMeasurements: 0, stepDescription: "Verificare il gioco degli ingranaggi e regolarlo secondo le specifiche tecniche per prevenire usura prematura." },
];
let reportsData = JSON.parse(localStorage.getItem('reportsData')) || {};
let currentReport = null;
let operatorsList = JSON.parse(localStorage.getItem('operatorsList')) || [];

function generateUniqueId() {
return 'step-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

function saveAllSteps() {
localStorage.setItem('allSteps', JSON.stringify(allSteps));
}

function saveOperatorsList() {
localStorage.setItem('operatorsList', JSON.stringify(operatorsList));
}

function saveReport() {
if (!currentReport) return;
const reportName = currentReport;
const reportData = {
details: {
macchinario: macchinarioField.value,
modello: document.getElementById('modello').value,
seriale: document.getElementById('seriale').value,
},
checklistConfig: reportsData[reportName].checklistConfig,
checklistData: {},
finalNotes: {
azioniCorrettive: document.getElementById('azioni-correttive').value,
noteAggiuntive: document.getElementById('note-aggiuntive').value,
}
};
const checklistItemsDiv = document.querySelectorAll('.checklist-item');
checklistItemsDiv.forEach((itemDiv) => {
const stepId = itemDiv.dataset.stepId;
const stepData = {
checked: itemDiv.querySelector('input[type="checkbox"]').checked,
date: itemDiv.querySelector('.step-date').value,
operator: itemDiv.querySelector('.step-operator').value,
notes: itemDiv.querySelector('.item-notes').value,
measurements: [],
images: []
};

const measurementInputs = itemDiv.querySelectorAll('.measurement-group input[type="text"]');
const measurementImageContainers = itemDiv.querySelectorAll('.measurement-group .image-container');
measurementInputs.forEach((input, i) => {
const img = measurementImageContainers[i].querySelector('.image-preview');
const imgSrc = img ? img.src : '';
stepData.measurements.push({ value: input.value, image: imgSrc });
});

const generalImages = itemDiv.querySelectorAll('.general-images .image-preview');
generalImages.forEach(img => {
stepData.images.push(img.src);
});

reportData.checklistData[stepId] = stepData;
});
reportsData[reportName] = reportData;
localStorage.setItem('reportsData', JSON.stringify(reportsData));
saveOperatorsList();
console.log(`Report for "${reportName}" saved.`);
}
function loadReport(reportName) {
if (!reportName || !reportsData[reportName]) {
clearReport();
return;
}
const reportData = reportsData[reportName];
currentReport = reportName;
macchinarioField.value = reportData.details.macchinario || '';
document.getElementById('modello').value = reportData.details.modello || '';
document.getElementById('seriale').value = reportData.details.seriale || '';
document.getElementById('azioni-correttive').value = reportData.finalNotes.azioniCorrettive || '';
document.getElementById('note-aggiuntive').value = reportData.finalNotes.noteAggiuntive || '';
renderChecklist(reportData.checklistConfig, reportData.checklistData);
updateProgressBar();
attachImageClickListeners();
toggleReportContent(true);
saveReportBtn.style.display = 'block';
}

function clearReport() {
macchinarioField.value = '';
document.getElementById('modello').value = '';
document.getElementById('seriale').value = '';
document.getElementById('azioni-correttive').value = '';
document.getElementById('note-aggiuntive').value = '';
renderChecklist([], {});
toggleReportContent(false);
saveReportBtn.style.display = 'none';
}

function toggleReportContent(show) {
mainReportContent.style.display = show ? 'block' : 'none';
manageChecklistBtn.style.display = show ? 'block' : 'none';
generatePdfBtn.style.display = show ? 'block' : 'none';
configSection.style.display = 'none';
}

function renderMachineSelector() {
machineSelector.innerHTML = '<option value="">- Seleziona un Report -</option>';
const machineNames = Object.keys(reportsData).sort();
machineNames.forEach(name => {
const option = document.createElement('option');
option.value = name;
option.textContent = name;
machineSelector.appendChild(option);
});
}
function renderChecklist(config, data) {
checklistDiv.innerHTML = '';
config.forEach((item, index) => {
const stepData = data[item.id] || {};
const itemDiv = document.createElement('div');
itemDiv.classList.add('checklist-item');
itemDiv.dataset.stepId = item.id;
let measurementFieldsHtml = '';
if (item.numMeasurements > 0) {
for (let i = 0; i < item.numMeasurements; i++) {
const measurementValue = (stepData.measurements && stepData.measurements[i]) ? stepData.measurements[i].value : '';
const measurementImage = (stepData.measurements && stepData.measurements[i]) ? stepData.measurements[i].image : '';
measurementFieldsHtml += `
<div class="measurement-group">
<label>Misura ${i + 1}:</label>
<input type="text" class="item-measurement" value="${measurementValue}" placeholder="Valore (es. 12.5 mm)">
<label for="image-upload-${item.id}-${i}" class="upload-btn">Allega foto per quota ${i + 1}</label>
<input type="file" id="image-upload-${item.id}-${i}" class="hidden-input" accept="image/*">
<div class="image-container">
${measurementImage ? `<img src="${measurementImage}" class="image-preview">` : ''}
</div>
</div>
`;
}
}
const stepDescriptionHtml = item.stepDescription ? `<p><b>Descrizione:</b> ${item.stepDescription}</p>` : '';
const generalImagesHtml = (stepData.images || []).map(imgSrc => `<img src="${imgSrc}" class="image-preview">`).join('');

itemDiv.innerHTML = `
<div class="form-group">
<label for="date-${item.id}">Data di esecuzione:</label>
<input type="date" class="step-date" id="date-${item.id}" value="${stepData.date || ''}">
</div>
<div class="form-group">
<label for="operator-${item.id}">Operatore:</label>
<input type="text" class="step-operator" id="operator-${item.id}" value="${stepData.operator || ''}" placeholder="Nome operatore" list="operatorsList">
<datalist id="operatorsList">
${operatorsList.map(name => `<option value="${name}">`).join('')}
</datalist>
</div>
<div class="item-header">
<input type="checkbox" id="check-${item.id}" ${stepData.checked ? 'checked' : ''}>
<label for="check-${item.id}">Step ${index + 1}: ${item.description}</label>
</div>
${stepDescriptionHtml}
${measurementFieldsHtml}
<textarea class="item-notes" placeholder="Note generali per lo Step ${index + 1}">${stepData.notes || ''}</textarea>
<label for="general-image-upload-${item.id}" class="upload-btn">Allega foto generale dello Step</label>
<input type="file" id="general-image-upload-${item.id}" class="hidden-input" accept="image/*">
<div class="image-container general-images">${generalImagesHtml}</div>
`;
checklistDiv.appendChild(itemDiv);
});
attachFileListeners();
}

function renderConfigList() {
allStepsList.innerHTML = '';
const reportConfig = reportsData[currentReport]?.checklistConfig || [];
const includedSteps = [];
const notIncludedSteps = [];

allSteps.forEach(step => {
if (reportConfig.some(s => s.id === step.id)) {
includedSteps.push(step);
} else {
notIncludedSteps.push(step);
}
});

allSteps = [...includedSteps, ...notIncludedSteps];
saveAllSteps();

allSteps.forEach((step, index) => {
const isIncluded = reportConfig.some(s => s.id === step.id);
const itemDiv = document.createElement('div');
itemDiv.classList.add('config-item');
if (isIncluded) {
itemDiv.classList.add('active');
}
itemDiv.dataset.stepId = step.id;
itemDiv.innerHTML = `
<div class="config-item-header">
<span class="handle">⋮</span>
<span>${step.description}</span>
<input type="checkbox" id="include-step-${step.id}" data-step-id="${step.id}" ${isIncluded ? 'checked' : ''}>
</div>
<div class="config-item-content">
<label>Titolo Step:</label>
<input type="text" value="${step.description}" data-step-id="${step.id}" class="config-description-input">
<label>Descrizione Dettagliata:</label>
<textarea data-step-id="${step.id}" class="config-step-description-input" rows="2">${step.stepDescription || ''}</textarea>
<div class="btn-group">
<label>Misure:</label>
<input type="number" min="0" value="${step.numMeasurements}" data-step-id="${step.id}" class="config-measure-count-input" style="width: 60px;">
<button class="delete-btn" onclick="showDeleteConfirm('${step.id}')">Elimina</button>
</div>
</div>
`;
allStepsList.appendChild(itemDiv);
});
document.querySelectorAll('.config-item-header').forEach(header => {
header.onclick = (e) => {
if (e.target.type !== 'checkbox' && !e.target.classList.contains('handle')) {
const content = header.nextElementSibling;
if (content.style.display === "flex") {
content.style.display = "none"
} else {
content.style.display = "flex"
}
}
};
});

initSortable();
}

function initSortable() {
if (allStepsList.sortable) {
allStepsList.sortable.destroy();
}
allStepsList.sortable = new Sortable(allStepsList, {
animation: 150,
handle: '.handle',
onEnd: function(evt) {
const newOrder = Array.from(allStepsList.children).map(li => allSteps.find(step => step.id === li.dataset.stepId));
allSteps = newOrder;
saveAllSteps();
if (currentReport) {
const newChecklistConfig = allSteps.filter(step => {
const input = document.getElementById(`include-step-${step.id}`);
return input && input.checked;
}).map(step => ({id: step.id, description: step.description, numMeasurements: step.numMeasurements, stepDescription: step.stepDescription}));
reportsData[currentReport].checklistConfig = newChecklistConfig;
saveReport();
}
}
});
}
window.showDeleteConfirm = function(stepId) {
const step = allSteps.find(s => s.id === stepId);
if (step) {
stepToDeleteName.textContent = step.description;
stepToDeleteId = stepId;
confirmModal.style.display = 'flex';
}
};

confirmDeleteBtn.addEventListener('click', () => {
if (stepToDeleteId) {
deleteStepModel(stepToDeleteId);
stepToDeleteId = null;
}
confirmModal.style.display = 'none';
});

cancelDeleteBtn.addEventListener('click', () => {
confirmModal.style.display = 'none';
stepToDeleteId = null;
});

function deleteStepModel(stepId) {
allSteps = allSteps.filter(step => step.id !== stepId);
saveAllSteps();
for (const reportName in reportsData) {
reportsData[reportName].checklistConfig = reportsData[reportName].checklistConfig.filter(s => s.id !== stepId);
delete reportsData[reportName].checklistData[stepId];
}
localStorage.setItem('reportsData', JSON.stringify(reportsData));
renderConfigList();
if (currentReport) loadReport(currentReport);
}

function handleImageUpload(event) {
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = function(e) {
const imageContainer = event.target.nextElementSibling;
const img = document.createElement('img');
img.src = e.target.result;
img.classList.add('image-preview');
imageContainer.appendChild(img);
attachImageClickListeners();
saveReport();
};
reader.readAsDataURL(file);
}

function updateProgressBar() {
const checkedCount = Array.from(document.querySelectorAll('#checklistItems input[type="checkbox"]')).filter(cb => cb.checked).length;
const totalCount = Array.from(document.querySelectorAll('#checklistItems input[type="checkbox"]')).length;
const percentage = totalCount > 0 ? (checkedCount / totalCount) * 100 : 0;
progressBar.style.width = `${percentage}%`;
progressBar.textContent = `${Math.round(percentage)}%`;
if (percentage < 33) {
progressBar.style.backgroundColor = '#f44336';
} else if (percentage < 66) {
progressBar.style.backgroundColor = '#ff9800';
} else {
progressBar.style.backgroundColor = '#4CAF50';
}
}

function attachFileListeners() {
document.querySelectorAll('input[type="file"]').forEach(input => {
input.removeEventListener('change', handleImageUpload);
input.addEventListener('change', handleImageUpload);
});
}

function attachImageClickListeners() {
document.querySelectorAll('.image-preview').forEach(img => {
img.removeEventListener('click', openModal);
img.addEventListener('click', openModal);
});
}
function openModal(e) {
modalImage.src = e.target.src;
photoModal.style.display = 'flex';
}

function showMessageBox(message, duration = 3000) {
messageBox.querySelector('span').textContent = message;
messageBox.style.opacity = 1;
setTimeout(() => {
messageBox.style.opacity = 0;
}, duration);
}
modalClose.onclick = function() {
photoModal.style.display = "none"
}

window.onclick = function(event) {
if (event.target == photoModal) {
photoModal.style.display = "none"
}
if (event.target == confirmModal) {
confirmModal.style.display = "none"
}
}
machineNameInput.addEventListener('input', (event) => {
macchinarioField.value = event.target.value;
});
loadReportBtn.addEventListener('click', () => {
currentReport = machineSelector.value;
if (currentReport) {
loadReport(currentReport);
} else {
alert("Seleziona un report da caricare.");
}
});

newMachineBtn.addEventListener('click', () => {
const newName = machineNameInput.value.trim();
if (newName && !reportsData[newName]) {
const initialChecklistConfig = allSteps.map(step => ({id: step.id, description: step.description, numMeasurements: step.numMeasurements, stepDescription: step.stepDescription}));
reportsData[newName] = {
details: { macchinario: newName, modello: '', seriale: '' },
checklistConfig: initialChecklistConfig,
checklistData: {},
finalNotes: { azioniCorrettive: '', noteAggiuntive: '' }
};
currentReport = newName;
renderMachineSelector();
machineSelector.value = newName;
loadReport(currentReport);
showMessageBox(`Nuovo report per "${newName}" creato!`);
machineNameInput.value = '';
} else if (newName) {
showMessageBox(`Il report per "${newName}" esiste già.`, 4000);
} else {
showMessageBox("Per favore, inserisci un nome per il nuovo report.", 4000);
}
});

saveReportBtn.addEventListener('click', () => {
if (currentReport) {
saveReport();
showMessageBox('Report salvato con successo!');
} else {
showMessageBox('Seleziona o crea prima un report.');
}
});

manageChecklistBtn.addEventListener('click', () => {
if (!currentReport) {
showMessageBox("Devi prima caricare un report per poter gestire gli step.", 4000);
return;
}
configSection.style.display = configSection.style.display === 'none' ? 'block' : 'none';
if (configSection.style.display === 'block') {
renderConfigList();
}
});
closeConfigBtn.addEventListener('click', () => {
configSection.style.display = 'none';
if(currentReport) {
loadReport(currentReport);
}
});

addNewStepBtn.addEventListener('click', () => {
const newStepName = prompt("Inserisci il nome del nuovo step:");
if (!newStepName) return;
const newStepDescription = prompt("Inserisci la descrizione dettagliata:");
const newStepMeasurements = prompt("Quante misure vuoi aggiungere a questo step? (Inserisci un numero):");
const numMeasurements = parseInt(newStepMeasurements) || 0;
const newStepId = generateUniqueId();
const newStep = {
id: newStepId,
description: newStepName,
numMeasurements: numMeasurements,
stepDescription: newStepDescription
};
allSteps.push(newStep);
saveAllSteps();
if (currentReport) {
reportsData[currentReport].checklistConfig.push(newStep);
saveReport();
}
renderConfigList();
});

generatePdfBtn.addEventListener('click', () => {
window.print();
});

document.addEventListener('input', function(event) {
if (!currentReport) return;
if (event.target.closest('#mainReportContent')) {
saveReport();
updateProgressBar();
} else if (event.target.closest('#configSection')) {
const stepId = event.target.dataset.stepId;
const step = allSteps.find(s => s.id === stepId);
if (step) {
let hasChanges = false;
if (event.target.classList.contains('config-description-input')) {
step.description = event.target.value;
hasChanges = true;
} else if (event.target.classList.contains('config-step-description-input')) {
step.stepDescription = event.target.value;
hasChanges = true;
} else if (event.target.classList.contains('config-measure-count-input')) {
const newCount = parseInt(event.target.value);
if (!isNaN(newCount) && newCount >= 0) {
step.numMeasurements = newCount;
hasChanges = true;
}
}
if (hasChanges) {
saveAllSteps();
const reportConfig = reportsData[currentReport].checklistConfig;
const updatedConfig = reportConfig.map(s => {
if (s.id === stepId) {
return {id: step.id, description: step.description, numMeasurements: step.numMeasurements, stepDescription: step.stepDescription};
}
return s;
});
reportsData[currentReport].checklistConfig = updatedConfig;
saveReport();
}
}
}
});

document.addEventListener('change', function(event) {
if (event.target.type === 'checkbox' && event.target.id.startsWith('include-step-')) {
const stepId = event.target.dataset.stepId;
const step = allSteps.find(s => s.id === stepId);
if (step && currentReport) {
const reportConfig = reportsData[currentReport].checklistConfig;
if (event.target.checked) {
const newStepData = {id: step.id, description: step.description, numMeasurements: step.numMeasurements, stepDescription: step.stepDescription};
reportConfig.push(newStepData);
} else {
reportsData[currentReport].checklistConfig = reportConfig.filter(s => s.id !== stepId);
delete reportsData[currentReport].checklistData[stepId];
}
saveReport();
renderConfigList();
}
} else if (event.target.closest('#mainReportContent')) {
saveReport();
if (event.target.type === 'checkbox' && event.target.id.startsWith('check-')) {
updateProgressBar();
}
}
});

// Nuovo event listener per salvare i nomi degli operatori quando si esce dal campo
document.addEventListener('focusout', function(event) {
if (event.target.classList.contains('step-operator')) {
const operatorName = event.target.value.trim();
if (operatorName !== '' && !operatorsList.includes(operatorName)) {
operatorsList.push(operatorName);
operatorsList.sort();
saveOperatorsList();
// Reload the datalist with the new list
const datalist = document.getElementById('operatorsList');
datalist.innerHTML = operatorsList.map(name => `<option value="${name}">`).join('');
}
}
});

document.addEventListener('DOMContentLoaded', () => {
allSteps.forEach(step => {
if (!step.id) {
step.id = generateUniqueId();
}
});
saveAllSteps();
renderMachineSelector();
});
</script>
</body>
</html>